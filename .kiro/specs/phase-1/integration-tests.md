# Phase 1: 基础设施 - 集成测试规范

## 概述

集成测试用于验证各个模块之间的协作是否正确。Phase 1 的集成测试主要关注以下三个方面：

1. **配置加载和使用** - 验证配置系统与其他模块的集成
2. **日志记录和输出** - 验证日志系统在实际应用中的表现
3. **服务器启动和请求处理** - 验证完整的请求处理流程

## 测试场景

### 1. 配置加载和使用集成测试

#### 1.1 配置文件加载与服务器初始化
**目标**: 验证从配置文件加载配置后，服务器能正确初始化

**步骤**:
1. 创建配置文件（config.yaml）
2. 使用 Load() 加载配置
3. 使用配置创建服务器
4. 验证服务器配置正确

**验证点**:
- 配置文件被正确加载
- 服务器使用了加载的配置
- 服务器能正常启动

#### 1.2 环境变量覆盖配置
**目标**: 验证环境变量能正确覆盖配置文件中的值

**步骤**:
1. 创建配置文件
2. 设置环境变量
3. 加载配置
4. 验证环境变量覆盖了配置文件的值

**验证点**:
- 环境变量正确覆盖配置
- 其他配置值保持不变
- 日志记录了配置加载过程

#### 1.3 配置与日志系统集成
**目标**: 验证配置中的日志设置能正确应用到日志系统

**步骤**:
1. 加载配置（包含日志配置）
2. 根据配置初始化日志系统
3. 记录日志
4. 验证日志级别和格式正确

**验证点**:
- 日志级别正确应用
- 日志格式正确应用
- 日志输出正确

### 2. 日志记录和输出集成测试

#### 2.1 服务器启动日志
**目标**: 验证服务器启动时记录的日志

**步骤**:
1. 初始化日志系统
2. 创建并启动服务器
3. 检查日志输出
4. 验证启动日志内容

**验证点**:
- 服务器启动日志被记录
- 日志包含服务器地址和端口
- 日志级别为 INFO

#### 2.2 请求处理日志
**目标**: 验证请求处理时记录的日志

**步骤**:
1. 初始化日志系统
2. 创建服务器
3. 发送请求
4. 检查日志输出
5. 验证请求日志内容

**验证点**:
- 请求日志被记录
- 日志包含请求方法、路径、状态码
- 日志包含响应时间
- 日志级别为 INFO

#### 2.3 错误日志
**目标**: 验证错误处理时记录的日志

**步骤**:
1. 初始化日志系统
2. 创建服务器
3. 发送导致错误的请求
4. 检查日志输出
5. 验证错误日志内容

**验证点**:
- 错误日志被记录
- 日志包含错误信息
- 日志级别为 ERROR
- 错误信息不泄露敏感信息

#### 2.4 日志格式验证
**目标**: 验证日志格式正确

**步骤**:
1. 初始化 JSON 格式日志
2. 记录日志
3. 解析日志输出
4. 验证 JSON 格式正确

**验证点**:
- 日志是有效的 JSON
- JSON 包含必要的字段（timestamp、level、message）
- JSON 包含自定义字段

### 3. 服务器启动和请求处理集成测试

#### 3.1 完整的请求处理流程
**目标**: 验证从请求接收到响应返回的完整流程

**步骤**:
1. 初始化配置和日志
2. 创建服务器
3. 发送请求
4. 验证响应
5. 检查日志

**验证点**:
- 请求被正确处理
- 响应格式正确
- 响应包含正确的数据
- 日志记录了请求和响应

#### 3.2 多个并发请求处理
**目标**: 验证服务器能正确处理多个并发请求

**步骤**:
1. 初始化服务器
2. 发送多个并发请求
3. 验证所有请求都被正确处理
4. 验证响应都是正确的

**验证点**:
- 所有请求都被处理
- 所有响应都是正确的
- 没有竞态条件
- 日志记录了所有请求

#### 3.3 不同类型的请求处理
**目标**: 验证服务器能正确处理不同类型的请求

**步骤**:
1. 初始化服务器
2. 发送 GET 请求
3. 发送 POST 请求
4. 发送 DELETE 请求
5. 发送 OPTIONS 请求
6. 验证所有请求都被正确处理

**验证点**:
- GET 请求返回正确的数据
- POST 请求返回正确的响应
- DELETE 请求返回正确的响应
- OPTIONS 请求返回正确的 CORS 头

#### 3.4 CORS 中间件集成
**目标**: 验证 CORS 中间件与服务器的集成

**步骤**:
1. 初始化服务器
2. 发送带有 Origin 头的请求
3. 验证响应包含 CORS 头
4. 验证 CORS 头的值正确

**验证点**:
- CORS 头被正确添加
- CORS 头的值正确
- 预检请求被正确处理

#### 3.5 日志中间件集成
**目标**: 验证日志中间件与服务器的集成

**步骤**:
1. 初始化日志系统
2. 初始化服务器
3. 发送请求
4. 检查日志输出
5. 验证日志中间件正确记录了请求

**验证点**:
- 日志中间件被正确应用
- 日志记录了请求信息
- 日志记录了响应信息
- 日志记录了处理时间

## 测试实现

### 测试文件结构

```
tests/
├── integration/
│   ├── config_integration_test.go      # 配置集成测试
│   ├── logger_integration_test.go      # 日志集成测试
│   ├── server_integration_test.go      # 服务器集成测试
│   └── fixtures/
│       └── config.yaml                 # 测试配置文件
└── testdata/
    └── ...
```

### 测试工具和库

- **testing**: Go 标准测试库
- **testify**: 断言库
- **httptest**: HTTP 测试工具

### 测试命令

```bash
# 运行所有集成测试
go test -v ./tests/integration/...

# 运行特定的集成测试
go test -v ./tests/integration/ -run TestConfigIntegration

# 运行集成测试并生成覆盖率报告
go test -v -cover ./tests/integration/...

# 运行集成测试并生成覆盖率文件
go test -v -coverprofile=coverage.out ./tests/integration/...
go tool cover -html=coverage.out
```

## 验收标准

### 功能完成
- [ ] 配置加载和使用集成测试完成
- [ ] 日志记录和输出集成测试完成
- [ ] 服务器启动和请求处理集成测试完成

### 测试覆盖
- [ ] 配置模块集成测试覆盖率 > 80%
- [ ] 日志模块集成测试覆盖率 > 80%
- [ ] 服务器模块集成测试覆盖率 > 80%

### 测试质量
- [ ] 所有测试都通过
- [ ] 没有测试失败
- [ ] 没有测试警告

### 文档完整
- [ ] 集成测试文档完整
- [ ] 测试用例清晰
- [ ] 测试步骤明确

## 相关文档

- [Phase 1 需求](./requirements.md)
- [Phase 1 设计](./design.md)
- [Phase 1 任务](./tasks.md)
- [代码规范](../../steering/code-standards.md)
- [API 设计](../../steering/api-design.md)

## 时间估计

- 配置集成测试: 0.5 天
- 日志集成测试: 0.5 天
- 服务器集成测试: 1 天

**总计**: 2 天

## 下一步

1. 创建集成测试文件
2. 实现配置集成测试
3. 实现日志集成测试
4. 实现服务器集成测试
5. 运行所有测试并验证覆盖率
6. 更新 Phase 1 进度文档
