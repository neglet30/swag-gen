# Phase 2: 核心功能 - 需求文档

## 项目概述

Phase 2 的目标是实现 swag-gen 的核心功能，包括 Go 代码解析、Swagger 文档生成和 CLI init 命令的完整实现。这是项目的关键阶段，将为后续的 Web UI 开发奠定基础。

## 功能需求

### 1. Go 代码解析器

#### 1.1 AST 解析
- 使用 `go/parser` 解析 Go 源文件
- 支持递归扫描目录
- 支持多个源文件的并发解析
- 提供错误处理和恢复机制

**验收标准**:
- 能够正确解析有效的 Go 源文件
- 能够处理语法错误的文件
- 能够递归扫描目录结构
- 支持并发解析提高性能

#### 1.2 注释解析
- 解析 Go 源代码中的 Swagger 注释
- 支持标准的 Swagger 标签格式
- 支持自定义标签格式
- 提供灵活的注释提取机制

**支持的标签**:
- `@Router`: 定义路由
- `@Param`: 定义参数
- `@Success`: 定义成功响应
- `@Failure`: 定义失败响应
- `@Summary`: 定义摘要
- `@Description`: 定义描述
- `@Tags`: 定义标签
- `@Deprecated`: 标记为已弃用

**验收标准**:
- 能够正确提取所有支持的标签
- 能够处理多行注释
- 能够处理缺失的标签
- 能够验证标签格式

#### 1.3 API 信息提取
- 从注释中提取 API 端点信息
- 提取请求参数信息
- 提取响应信息
- 提取数据模型信息

**验收标准**:
- 能够提取完整的 API 信息
- 能够识别参数类型和位置
- 能够识别响应状态码
- 能够识别数据模型

### 2. Swagger 文档生成

#### 2.1 OpenAPI 3.0 规范生成
- 生成符合 OpenAPI 3.0 规范的文档
- 支持 JSON 和 YAML 格式输出
- 支持自定义文档信息
- 提供完整的 API 定义

**验收标准**:
- 生成的文档符合 OpenAPI 3.0 规范
- 支持 JSON 格式输出
- 支持 YAML 格式输出
- 文档包含完整的 API 定义

#### 2.2 数据模型处理
- 识别和提取数据模型定义
- 生成 Schema 定义
- 支持嵌套模型
- 支持数组和基本类型

**验收标准**:
- 能够识别 struct 定义
- 能够生成正确的 Schema
- 能够处理嵌套结构
- 能够处理数组类型

#### 2.3 文档优化
- 自动生成文档摘要
- 自动生成文档描述
- 自动识别参数类型
- 自动识别响应类型

**验收标准**:
- 文档内容完整准确
- 参数类型识别正确
- 响应类型识别正确
- 文档格式规范

### 3. CLI init 命令完整实现

#### 3.1 命令参数
- `-p, --path`: 项目路径（必需）
- `-o, --output`: 输出路径（可选，默认 ./docs）
- `-t, --title`: API 标题（可选）
- `-v, --version`: API 版本（可选，默认 1.0.0）
- `-d, --description`: API 描述（可选）
- `-f, --format`: 输出格式（可选，默认 json）

**验收标准**:
- 所有参数都能正确解析
- 参数验证正确
- 提供清晰的错误提示

#### 3.2 初始化流程
1. 验证输入参数
2. 扫描项目目录
3. 解析 Go 源文件
4. 提取 API 信息
5. 生成 Swagger 文档
6. 保存输出文件
7. 生成配置文件

**验收标准**:
- 流程执行完整
- 每个步骤都有错误处理
- 提供进度反馈
- 生成完整的输出

#### 3.3 输出文件
- `swagger.json` 或 `swagger.yaml`: Swagger 文档
- `swag-gen.yaml`: 项目配置文件
- `README.md`: 使用说明

**验收标准**:
- 所有文件都能正确生成
- 文件格式正确
- 文件内容完整

### 4. 错误处理和日志

#### 4.1 错误处理
- 提供清晰的错误信息
- 支持错误恢复
- 支持部分失败继续处理
- 提供错误代码

**验收标准**:
- 错误信息清晰易懂
- 错误处理完善
- 支持错误恢复

#### 4.2 日志记录
- 记录解析过程
- 记录生成过程
- 记录错误和警告
- 支持日志级别配置

**验收标准**:
- 日志记录完整
- 日志信息有用
- 支持日志级别配置

## 非功能需求

### 性能
- 解析 1000 个文件 < 5 秒
- 生成 Swagger 文档 < 1 秒
- 内存使用 < 100MB
- 支持大型项目

### 可靠性
- 错误处理完善
- 支持部分失败继续处理
- 支持重试机制
- 数据一致性保证

### 可维护性
- 代码遵循规范
- 有清晰的注释
- 有完整的文档
- 支持扩展

### 安全性
- 输入验证
- 路径验证
- 防止目录遍历
- 敏感信息保护

## 用户故事

### 用户故事 1: 解析 Go 源文件
作为一个开发者，我想要 swag-gen 能够自动解析我的 Go 源文件中的 Swagger 注释，以便自动生成 API 文档。

**验收标准**:
- 能够正确解析 Go 源文件
- 能够提取 Swagger 注释
- 能够识别 API 端点
- 能够处理解析错误

### 用户故事 2: 生成 Swagger 文档
作为一个开发者，我想要 swag-gen 能够生成符合 OpenAPI 3.0 规范的 Swagger 文档，以便在 Swagger UI 中查看。

**验收标准**:
- 生成的文档符合 OpenAPI 3.0 规范
- 文档包含完整的 API 定义
- 支持 JSON 和 YAML 格式
- 文档内容准确完整

### 用户故事 3: 使用 init 命令初始化项目
作为一个开发者，我想要使用 `swag-gen init` 命令快速初始化项目并生成 Swagger 文档，以便快速开始使用。

**验收标准**:
- 命令能够接受必要的参数
- 命令能够完整执行初始化流程
- 命令能够生成所有必要的文件
- 命令提供清晰的反馈信息

### 用户故事 4: 处理大型项目
作为一个开发者，我想要 swag-gen 能够高效地处理大型项目，以便快速生成文档。

**验收标准**:
- 能够处理 1000+ 个文件
- 性能满足要求
- 内存使用合理
- 支持并发处理

## 接受标准

### 功能完成
- [ ] Go 代码解析器实现完成
- [ ] Swagger 文档生成实现完成
- [ ] CLI init 命令实现完成
- [ ] 错误处理完善
- [ ] 日志记录完整

### 代码质量
- [ ] 代码遵循规范
- [ ] 有单元测试
- [ ] 测试覆盖率 > 80%
- [ ] 没有 lint 错误

### 文档完整
- [ ] 有 API 文档
- [ ] 有使用示例
- [ ] 有故障排除指南
- [ ] 有性能指标

### 性能指标
- [ ] 解析 1000 个文件 < 5 秒
- [ ] 生成 Swagger 文档 < 1 秒
- [ ] 内存使用 < 100MB
- [ ] 支持大型项目

## 依赖关系

- Phase 1 基础设施完成
- Go 1.25.5+
- go/ast, go/parser 标准库
- Zap 日志库
- Cobra CLI 框架

## 风险和缓解措施

### 风险 1: 注释格式多样化
**缓解**: 定义清晰的注释规范，提供灵活的解析机制

### 风险 2: 性能不达标
**缓解**: 使用并发处理，进行性能测试和优化

### 风险 3: 复杂的数据模型处理
**缓解**: 逐步实现，从简单到复杂

### 风险 4: 大型项目处理
**缓解**: 进行大型项目测试，优化内存使用

## 时间估计

- Go 代码解析器: 3 天
- Swagger 文档生成: 2 天
- CLI init 命令: 1.5 天
- 错误处理和日志: 1 天
- 单元测试: 2 天
- 文档编写: 1 天

**总计**: 10.5 天（预计 2 周内完成）

## 相关文档

- [开发计划](../../steering/development-plan.md)
- [代码规范](../../steering/code-standards.md)
- [API 设计](../../steering/api-design.md)
- [技术栈](../../steering/tech.md)
- [Phase 1 需求](../phase-1/requirements.md)
